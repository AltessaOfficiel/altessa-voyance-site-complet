<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Altessa Voyance ‚Äî Poser votre question</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/styles.css" />

  <!-- PAYPAL SDK -->
  <script 
    src="https://www.paypal.com/sdk/js?client-id=BAA3LPdWYhDwfbYcXsmBhfCHXhRtcth_XEFw9tpnDSr42xeS7cdHDPl4kkudskfXSomt0uyjCfsdvzBBz8&components=hosted-buttons&disable-funding=venmo&currency=EUR">
  </script>
</head>

<body class="page-contact">

<header class="header">
  <div class="logo">
    <img src="assets/img/logo-altessa.png" alt="Logo Altessa">
    <div class="logo-text">
      <span class="logo-main">Altessa</span>
      <span class="logo-sub">Voyance</span>
    </div>
  </div>

  <nav class="nav">
    <a href="index.html">Accueil</a>
    <a href="experts.html">Experts</a>
    <a href="tarifs.html">Tarifs</a>
    <a href="contact.html" class="btn-nav active">Contact</a>
  </nav>
</header>

<main>

  <section class="hero hero-inner">
    <h1 class="hero-title hero-title-small">Poser votre question</h1>
    <p class="hero-text hero-text-centered">
      Choisissez votre consultation, r√©glez en toute s√©curit√©, puis posez votre question.<br>
      R√©ponse envoy√©e sous 30 minutes √† 2h.
    </p>
  </section>

  <section class="section">

    <!-- FORMULAIRE DE CHOIX AVANT PAIEMENT -->
    <form class="contact-form" id="select-form">

      <div class="form-row">
        <label>Expert s√©lectionn√©</label>
        <input type="text" id="expert" readonly>
      </div>

      <div class="form-row">
        <label>Type de consultation*</label>
        <select id="type" required>
          <option value="">Choisissez‚Ä¶</option>
          <option value="question">√Ä la question ‚Äî 8‚Ç¨</option>
          <option value="sentimentale">Sentimentale ‚Äî 20‚Ç¨</option>
          <option value="professionnelle">Professionnelle ‚Äî 20‚Ç¨</option>
          <option value="financiere">Financi√®re ‚Äî 20‚Ç¨</option>
          <option value="generale">G√©n√©rale ‚Äî 45‚Ç¨</option>
          <option value="soin">Soin √©nerg√©tique ‚Äî 50‚Ç¨</option>
        </select>
      </div>
    </form>

    <!-- CONTENEUR QUI CHANGE SELON LE TYPE -->
    <div id="paypal-zone"></div>

  </section>
</main>

<footer class="footer">
  Altessa Voyance ¬© ‚Äî Service r√©serv√© aux personnes majeures.
</footer>

<script>
  /* Remplit automatiquement l‚Äôexpert selon l‚ÄôURL */
  const params = new URLSearchParams(window.location.search);
  const expert = params.get("expert");
  document.getElementById("expert").value = expert || "Non sp√©cifi√©";

  /* IDs des boutons PayPal */
  const paypalIDs = {
    question: "LGCWPQ9JHDT5U",
    sentimentale: "H8LA54EZY2T46",
    professionnelle: "A3DZS2TAYSGYS",
    financiere: "AJDZ94JCHR8U8",
    generale: "AY42SMUCPK3YU",
    soin: "GT986X6GT42PA"
  };

  /* Affiche le bouton PayPal correspondant */
  const typeSelect = document.getElementById("type");
  const paypalZone = document.getElementById("paypal-zone");

  typeSelect.addEventListener("change", () => {
    const t = typeSelect.value;
    paypalZone.innerHTML = "";

    if (!t) return;

    const div = document.createElement("div");
    div.id = "paypal-container";
    paypalZone.appendChild(div);

    paypal.HostedButtons({
      hostedButtonId: paypalIDs[t]
    }).render("#paypal-container");

    // Ajout redirection personnalis√©e
    const checkInterval = setInterval(() => {
      const links = document.querySelectorAll("form[action*='paypal']");
      if (links.length) {
        links.forEach(f => {
          f.action = f.action + "&custom=" + encodeURIComponent(`${expert}|${t}`);
        });
        clearInterval(checkInterval);
      }
    }, 300);
  });
</script>
<script>
// ------------------------------
//  CONFIG PAYPAL : IDs par type
// ------------------------------
const paypalIDs = {
  question: "LGCWPQ9JHDT5U",          // 8‚Ç¨
  sentimentale: "H8LA54EZY2T46",       // 20‚Ç¨
  professionnelle: "A3DZS2TAYSGYS",    // 20‚Ç¨
  financiere: "AJDZ94JCHR8U8",         // 20‚Ç¨
  generale: "GT986X6GT42PA",           // 45‚Ç¨
  soin: "AY42SMUCPK3YU"                // 50‚Ç¨
};

// R√©cup√©rer √©l√©ments du formulaire
const typeSelect = document.getElementById("type");
const form = document.getElementById("voyance-form");

// Stockage temporaire avant paiement
let formDataTemp = {};

// Sauvegarde des donn√©es du formulaire AVANT l'envoi
form.addEventListener("submit", function (e) {
  e.preventDefault();

  const selectedType = typeSelect.value;

  if (!selectedType || !paypalIDs[selectedType]) {
    alert("Veuillez s√©lectionner un type de consultation valide.");
    return;
  }

  // Sauvegarder toutes les donn√©es du formulaire
  const formData = new FormData(form);
  formDataTemp = Object.fromEntries(formData.entries());

  // üî• G√âN√âRATION DU LIEN PAYPAL HOSTED BUTTON
  const paypalURL = `https://www.paypal.com/ncp/payment/${paypalIDs[selectedType]}`;

  // Rediriger vers PayPal
  window.location.href = paypalURL;
});

// ---------------------------
//  V√©rifier retour du paiement
// ---------------------------
function getParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

// V√©rification : "success" renvoy√© par PayPal
if (getParam("payment") === "success") {
  
  // Envoi automatique vers Formspree (apr√®s paiement valid√©)
  fetch("https://formspree.io/f/xzzngjaq", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(formDataTemp)
  }).then(() => {
    // Redirection vers la page MERCI personnalis√©e
    const expertName = formDataTemp.expert || "expert";
    const type = formDataTemp.type || "";
    
    window.location.href =
      `https://altessavoyance.com/merci.html?expert=${expertName}&type=${type}`;
  });
}
</script>

</body>
</html>
